---
title: "STAT 5702: Homework 4"
output: html_notebook
---

### Introduction 

Indego is the de facto bike sharing network in Philadelphia. It has become a popular, more eco-friendly alternative for short trips across the city since launching in late April of 2015. However, little has been done to analyze the publicly available data associated with Indego. Thus, we think it would be beneficial to the public if we quantify and assess several pertinent features and patterns related to Indego, generating insights on how the bike sharing network is utilized across the city. More specifically, we want to examine volume of bike traffic across different time sections, duration of rides, travel patterns, and kiosk hotspots. Time permitting, we also want to examine real-time frequency of trips across the city.<br>

Our objective starting out was to examine bike share programs in the most populated cities across the eastern United States. Since Philadelphia is the second largest city satisfying this criteria and has a relatively new bike share program, we thought the Indego dataset would be an ideal choice. The dataset is publicly available on Indego's website (https://www.rideindego.com/about/data/). It can be found by clicking the <i>About</i> panel and then selecting <i>Data</i>.

### Team 

1. Hung-Shi Lin (hl2997)  
2. Mason Sun (zs2321)  
3. Kejia Shi (ks3403)  

Each team member will contribute equally to the project. This applies to data preprocessing, exploratory data analysis, statistical modelling, visualization (static/real-time), and writing the report.<br>

### Preliminary analysis
```{r}
library(tidyverse)
data = read.csv("./data/Indego_trips_Q4_2016.csv")
```

Here we will examine the Indego dataset of the latest quarter for which data is available. This is Q4 of 2016 in our case. Time permitting, we would like to examine the other datasets available (i.e. all the other quarters prior to Q4 of 2016) to get a better, more holistic perspective of Indego. This would be easy as all the other datasets have the same features we consider here.<br>

The four variables we will be examining here are "duration" (duration of trips), "start_station_id" (station where bikes are rented), "passholder_type" (type of pass each rider uses to rent a bike), and "trip_route_category" (one way or roundtrip). However, we also consider other variables in our analyses.<br>

#### Most popular kiosks
```{r fig.width=6, fig.height=4, warning=FALSE}
hotspot = data
id = read.csv('./data/indego_stations.csv')
station_id = dplyr::select(hotspot, start_station_id)
stations = right_join(id, station_id, by = c("Station.ID" = "start_station_id"))
station_df = data.frame(table(stations['Station.Name']))
total_station = nrow(station_df)
sub_station_df = station_df[1:20,]
len = nrow(sub_station_df)
ggplot(sub_station_df, aes(x =reorder(Var1, Freq), y = Freq, fill = Freq)) + geom_bar(stat = 'identity')  + coord_flip()
boxplot(sub_station_df$Freq)
stats = boxplot.stats(sub_station_df$Freq)
# cat('Minimum: ', stats$stats[1], '\n')
# cat("Average: ", stats$stats[3], '\n')
# cat('Interquartile: ', stats$stats[4] - stats$stats[2], '\n')
# cat('Maximum: ', stats$out, '\n')
# top3_weight = sum(sub_station_df[1:3,'Freq']) / sum(sub_station_df[,'Freq'])
# cat("total stations: ", total_station, '\n')
# cat('weight of three top hotspot station: ', top3_weight, '\n')
```

Based on the point of bike rents, we can understand determine the populartiy of kiosks (we use this term interchangeably with station) across the city. Out of the total 107 kiosks described in the dataset, we plot the 20 that are most popular with respect to bike rents. The average and interquartile range across these 20 kiosks is approximately 2105 and 1497, respectively. It should be noted that there exists an outlier, in which the frequency is 5470. More specifically, the top three most popular kiosks account for 10% of the top twenty. In the future, we hope to explore and better understand the geometric relationship among these kiosks (e.g. are they close to popular subway stations, bus stops, or attractions?). In addition, we hope to analyze the variation in popularity among different kiosks to faciliatate higher usage rate across all stations.<br>

#### Total count across different passholders (by month)
```{r, warning=FALSE}
Y16Q4 <- read.csv("./data/Indego_trips_Q4_2016.csv", header=T)
df <- Y16Q4[,-c(1,6,7,9,10,12)]

# Data Inspection
df$duration <- df$duration/60
# max(df$duration)
# table(df$passholder_type)
# table(df$passholder_type, df$trip_route_category)
# length(unique(df$bike_id))
# length(unique(df$start_station_id))
# length(unique(df$end_station_id))

# Time + Date Separation
df$s_hour <- format(as.POSIXct(strptime(df$start_time,"%m/%d/%Y %H:%M",tz="")) ,format = "%H")
df$e_hour <- format(as.POSIXct(strptime(df$end_time,"%m/%d/%Y %H:%M",tz="")) ,format = "%H")
df$month <- format(as.POSIXct(strptime(df$start_time,"%m/%d/%Y %H:%M",tz="")) ,format = "%m")
df$day <- format(as.POSIXct(strptime(df$start_time,"%m/%d/%Y %H:%M",tz="")) ,format = "%d")
df <- df[,-c(2,3)]
```

```{r fig.width=6, fig.height=6, warning=FALSE}
passholder <- df %>% group_by(month,day,passholder_type) %>% summarize(count = n())
foo <- passholder %>% group_by(month,day) %>% summarize(count = sum(count))
foo$passholder_type <- "All"
colnames(foo)
foo <- foo[,c("month","day","passholder_type","count")]
passholder <- rbind(passholder, foo)
rm(foo)
ggplot(passholder, aes(x = day, y = count, color = month)) +
  geom_line(aes(group = month)) +
  facet_wrap(~ passholder_type, scales = "free", ncol=1)
```

As we can see from the total counts across different passholder types, there are some insights worth mentioning. First and foremost, there does not seem to be clear patterns in regards to daily trips for different passholders. However, we know for certain time periods (e.g. 11/01/2016 - 11/04/2016), more people use Indego. There also exist more granular trends. For instance, less people travel in December than November and October.<br>

#### Rent and return hours
```{r}
# Multiple plot function
# Source: http://www.cookbook-r.com
# ggplot objects can be passed in ..., or to plotlist (as a list of ggplot objects)
# - cols:   Number of columns in layout
# - layout: A matrix specifying the layout. If present, 'cols' is ignored.
#
# If the layout is something like matrix(c(1,2,3,3), nrow=2, byrow=TRUE),
# then plot 1 will go in the upper left, 2 will go in the upper right, and
# 3 will go all the way across the bottom.
multiplot <- function(..., plotlist=NULL, file, cols=1, layout=NULL) {
  require(grid)
  # Make a list from the ... arguments and plotlist
  plots <- c(list(...), plotlist)
  numPlots = length(plots)
  # If layout is NULL, then use 'cols' to determine layout
  if (is.null(layout)) {
    # Make the panel
    # ncol: Number of columns of plots
    # nrow: Number of rows needed, calculated from # of cols
    layout <- matrix(seq(1, cols * ceiling(numPlots/cols)),
                     ncol = cols, nrow = ceiling(numPlots/cols))
  }
  if (numPlots==1) {
    print(plots[[1]])
  } else {
    # Set up the page
    grid.newpage()
    pushViewport(viewport(layout = grid.layout(nrow(layout), ncol(layout))))
    # Make each plot, in the correct location
    for (i in 1:numPlots) {
      # Get the i,j matrix positions of the regions that contain this subplot
      matchidx <- as.data.frame(which(layout == i, arr.ind = TRUE))
      print(plots[[i]], vp = viewport(layout.pos.row = matchidx$row,
                                      layout.pos.col = matchidx$col))
    }
  }
}
```

```{r fig.width=6, fig.height=4, warning=FALSE}
theme_set(theme_classic())

g1 <- ggplot(df, aes(s_hour)) + scale_fill_brewer(palette = "Spectral") + 
  geom_histogram(aes(fill=trip_route_category), stat="count", col="black") + 
  labs(title="Histogram of Start Hour", subtitle="across Trip Route Categories") 

g2 <- ggplot(df, aes(e_hour)) + scale_fill_brewer(palette = "Spectral") + 
  geom_histogram(aes(fill=trip_route_category), stat="count", col="black") + 
  labs(title="Histogram of End Hour", subtitle="across Trip Route Categories") 

g3 <- ggplot(df, aes(s_hour)) + scale_fill_brewer(palette = "Spectral") + 
  geom_histogram(aes(fill=passholder_type), stat="count", col="black") + 
  labs(title="Histogram of Start Hour", subtitle="across Passholder Types") 

g4 <- ggplot(df, aes(e_hour)) + scale_fill_brewer(palette = "Spectral") + 
  geom_histogram(aes(fill=passholder_type), stat="count", col="black") + 
  labs(title="Histogram of End Hour", subtitle="across Passholder Types") 

multiplot(g1, g2, g3, g4, cols=2)
```

From the histograms that illustrate bike trips by hours of data contingent on the various trip routes and passholder types, we see several salient patterns:
1. The most popular hours to rent and return are 8:00 and 17:00 respectively, which reflect the time periods that people go to and leave work or school.
2. One-way trips and 30-day passes are the most popular choices. Only a small fraction of riders choose flexible accounts. The rest of the bike sharing demographic are walk-up renters.
3. Peak renting hours are the intervals 7:00-10:00 and 14:00-20:00, and the peak return hours are the intervals 8:00-10:00 and 15:00-20:00. We can conjecturally demonstrate that most riders opt for approximately one hour rides.<br>

#### Duration of trips
```{r fig.width=6, fig.height=3, warning=FALSE}
hour <- df$duration
dur <- cut(hour, c(0,5,10,15,20,30,60,120,240,1440))
table(dur)
plot(dur, ylim=c(0,60000), main='Duration Distribution\nby minutes')
```

From the duration plots above, we observe most people choose public bikes for short commutes. The most prevalent duration of bike rides lie between 5 and 10 minutes. The second most common duration of bike rides are 10-15 minutes. In fact, the majority of trips are less than 30 minutes. On the contrary, we see that long trips are actually outliers in our dataset. Trips between two and four hours only make up 0.9% of all rides, and trips exceeding 4 hours make up 0.7% of the total.<br>

#### Frequency of bike use
```{r fig.width=6, fig.height=3, warning=FALSE}
freq <- table(df$bike_id)
fre <- cut(freq, c(0,50,100,150,200,250,300))
table(fre)
plot(fre, ylim=c(0,500), main='Bike Using Frequencies')
```

We would also like to examine the depreciation of bike, so we plot total bike use against the three months under consideration. Most bikes are used 100 to 250 times between October and December of 2016. About 5.7% of the total bikes have been used for more than 250 times, while 4.5% of the total bikes are used less than 100 times.<br>
